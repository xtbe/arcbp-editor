<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <script src="https://cdn.jsdelivr.net/npm/@tailwindcss/browser@4"></script>
    <script
      src="https://browser.sentry-cdn.com/7.99.0/bundle.tracing.replay.min.js"
      crossorigin="anonymous"
    ></script>
    <script>
      Sentry.init({
    dsn: "your-dsn-url-here",
    environment: "production",
    debug: true,

    integrations: [new Sentry.BrowserTracing(), new Sentry.Replay()],
    tracesSampleRate: 1.0,
    replaysSessionSampleRate: 0.1,
    replaysOnErrorSampleRate: 1.0,
  });

    // Sentry.captureMessage("GlitchTip connection test: captureMessage"); 
    </script>
    <title>Blueprints Data Entry</title>
  </head>

  <body class="bg-zinc-950 text-zinc-100 min-h-screen">
    <header
      class="sticky top-0 z-10 bg-zinc-950/85 backdrop-blur border-b border-zinc-800"
    >
      <div
        class="max-w-7xl mx-auto px-4 py-3 flex flex-wrap items-center gap-2"
      >
        <div class="flex items-center gap-3 mr-auto">
          <div
            class="w-9 h-9 rounded-xl bg-zinc-900 border border-zinc-800 grid place-items-center"
          >
            <span class="text-lg">üßæ</span>
          </div>
          <div>
            <div class="font-semibold leading-tight">Blueprints Editor</div>
            <div class="text-xs text-zinc-400">
              Single-page JSON data entry ¬∑ Load / Save ¬∑ Autosave ¬∑ Paging
            </div>
          </div>
        </div>

        <button
          id="btnNew"
          class="px-3 py-2 rounded-xl bg-emerald-600/90 hover:bg-emerald-600 text-sm font-medium"
        >
          + New blueprint
        </button>

        <label
          class="px-3 py-2 rounded-xl bg-zinc-900 hover:bg-zinc-800 border border-zinc-800 text-sm font-medium cursor-pointer"
        >
          Load JSON file
          <input
            id="fileInput"
            type="file"
            accept="application/json,.json"
            class="hidden"
          />
        </label>

        <button
          id="btnPaste"
          class="px-3 py-2 rounded-xl bg-zinc-900 hover:bg-zinc-800 border border-zinc-800 text-sm font-medium"
        >
          Paste JSON
        </button>

        <button
          id="btnViewJson"
          class="px-3 py-2 rounded-xl bg-indigo-600/90 hover:bg-indigo-600 text-sm font-medium"
        >
          View JSON
        </button>

        <button
          id="btnReset"
          class="px-3 py-2 rounded-xl bg-zinc-900 hover:bg-zinc-800 border border-zinc-800 text-sm font-medium"
        >
          Reset to sample
        </button>
      </div>
    </header>

    <main class="max-w-7xl mx-auto px-4 py-6">
      <div class="grid grid-cols-1 lg:grid-cols-12 gap-4">
        <!-- Left: list -->
        <section class="lg:col-span-5 xl:col-span-4">
          <div
            class="rounded-2xl border border-zinc-800 bg-zinc-900/40 overflow-hidden"
          >
            <div class="p-3 border-b border-zinc-800 flex items-center gap-2">
              <input
                id="search"
                placeholder="Search name/workshop‚Ä¶"
                class="w-full px-3 py-2 rounded-xl bg-zinc-950 border border-zinc-800 focus:outline-none focus:ring-2 focus:ring-indigo-500 text-sm"
              />
              <select
                id="filterAvailability"
                class="px-3 py-2 rounded-xl bg-zinc-950 border border-zinc-800 focus:outline-none focus:ring-2 focus:ring-indigo-500 text-sm"
              >
                <option value="all">All</option>
                <option value="available">Available</option>
                <option value="unavailable">Unavailable</option>
              </select>
            </div>

            <div id="list" class="max-h-[72vh] overflow-auto"></div>

            <!-- Paging bar -->
            <div
              class="p-3 border-t border-zinc-800 flex flex-wrap items-center gap-2 justify-between text-xs text-zinc-400"
            >
              <div class="flex items-center gap-2">
                <div><span id="countShown">0</span> shown</div>
                <div class="text-zinc-500">¬∑</div>
                <div>
                  Page <span id="pageNow">1</span>/<span id="pageTotal">1</span>
                </div>
              </div>

              <div class="flex items-center gap-2">
                <label class="flex items-center gap-2">
                  <span class="text-zinc-400">Per page</span>
                  <select
                    id="pageSize"
                    class="px-2 py-1 rounded-lg bg-zinc-950 border border-zinc-800 focus:outline-none focus:ring-2 focus:ring-indigo-500 text-xs"
                  >
                    <option value="10" selected>10</option>
                    <option value="25">25</option>
                    <option value="50">50</option>
                    <option value="100">100</option>
                  </select>
                </label>

                <button
                  id="btnPrevPage"
                  class="px-2.5 py-1.5 rounded-lg bg-zinc-900 hover:bg-zinc-800 border border-zinc-800 text-xs font-medium disabled:opacity-40 disabled:cursor-not-allowed"
                >
                  Prev
                </button>
                <button
                  id="btnNextPage"
                  class="px-2.5 py-1.5 rounded-lg bg-zinc-900 hover:bg-zinc-800 border border-zinc-800 text-xs font-medium disabled:opacity-40 disabled:cursor-not-allowed"
                >
                  Next
                </button>

                <div class="text-zinc-500 hidden sm:block">
                  Autosave: <span class="text-zinc-300">on</span>
                </div>
              </div>
            </div>
          </div>

          <div id="status" class="mt-3 text-sm"></div>
        </section>

        <!-- Right: editor -->
        <section class="lg:col-span-7 xl:col-span-8">
          <div
            class="rounded-2xl border border-zinc-800 bg-zinc-900/40 overflow-hidden"
          >
            <div class="p-4 border-b border-zinc-800 flex items-center gap-2">
              <div class="mr-auto">
                <div class="font-semibold">Editor</div>
                <div class="text-xs text-zinc-400">
                  Select a blueprint on the left to edit
                </div>
              </div>
              <button
                id="btnDuplicate"
                class="px-3 py-2 rounded-xl bg-zinc-900 hover:bg-zinc-800 border border-zinc-800 text-sm font-medium disabled:opacity-40 disabled:cursor-not-allowed"
              >
                Duplicate
              </button>
              <button
                id="btnDelete"
                class="px-3 py-2 rounded-xl bg-red-600/90 hover:bg-red-600 text-sm font-medium disabled:opacity-40 disabled:cursor-not-allowed"
              >
                Delete
              </button>
            </div>

            <div id="editor" class="p-4">
              <div class="text-zinc-400 text-sm">No blueprint selected.</div>
            </div>
          </div>
        </section>
      </div>
    </main>

    <!-- Paste modal -->
    <div
      id="modalPaste"
      class="fixed inset-0 hidden items-center justify-center p-4"
    >
      <div class="absolute inset-0 bg-black/70"></div>
      <div
        class="relative w-full max-w-3xl rounded-2xl border border-zinc-800 bg-zinc-900 shadow-2xl overflow-hidden"
      >
        <div
          class="p-4 border-b border-zinc-800 flex items-center justify-between"
        >
          <div>
            <div class="font-semibold">Paste JSON</div>
            <div class="text-xs text-zinc-400">
              Must be a JSON object with a
              <code class="text-zinc-200">blueprints</code> array
            </div>
          </div>
          <button
            id="btnClosePaste"
            class="px-3 py-2 rounded-xl bg-zinc-900 hover:bg-zinc-800 border border-zinc-800 text-sm font-medium"
          >
            Close
          </button>
        </div>
        <div class="p-4">
          <textarea
            id="pasteArea"
            class="w-full h-64 p-3 rounded-xl bg-zinc-950 border border-zinc-800 focus:outline-none focus:ring-2 focus:ring-indigo-500 text-xs"
            placeholder='{"blueprints":[{"name":"Example","workshop":"Gunsmith I","image":"images/example.png","crafting_recipe":[{"item":"Duct Tape","quantity":1}],"available":true,"loot":false,"harvester_event":false,"quest_reward":false,"trials_reward":false}]}'
          ></textarea>
          <div class="mt-3 flex items-center gap-2 justify-end">
            <button
              id="btnLoadPasted"
              class="px-3 py-2 rounded-xl bg-indigo-600/90 hover:bg-indigo-600 text-sm font-medium"
            >
              Load
            </button>
          </div>
          <div id="pasteError" class="mt-2 text-sm text-red-300"></div>
        </div>
      </div>
    </div>

    <!-- JSON preview modal -->
    <div
      id="modalJson"
      class="fixed inset-0 hidden items-center justify-center p-4"
    >
      <div class="absolute inset-0 bg-black/70"></div>
      <div
        class="relative w-full max-w-4xl rounded-2xl border border-zinc-800 bg-zinc-900 shadow-2xl overflow-hidden"
      >
        <div
          class="p-4 border-b border-zinc-800 flex items-center justify-between gap-2"
        >
          <div>
            <div class="font-semibold">JSON Preview</div>
            <div class="text-xs text-zinc-400">
              This is what will be saved/downloaded
            </div>
          </div>
          <div class="flex items-center gap-2">
            <button
              id="btnCopyJson"
              class="px-3 py-2 rounded-xl bg-zinc-900 hover:bg-zinc-800 border border-zinc-800 text-sm font-medium"
            >
              Copy
            </button>
            <button
              id="btnDownloadJson"
              class="px-3 py-2 rounded-xl bg-indigo-600/90 hover:bg-indigo-600 text-sm font-medium"
            >
              Download
            </button>
            <button
              id="btnCloseJson"
              class="px-3 py-2 rounded-xl bg-zinc-900 hover:bg-zinc-800 border border-zinc-800 text-sm font-medium"
            >
              Close
            </button>
          </div>
        </div>
        <pre
          id="jsonPreview"
          class="p-4 text-xs overflow-auto max-h-[75vh] bg-zinc-950 border-t border-zinc-800"
        ></pre>
      </div>
    </div>

    <script>
      ;(() => {
        const STORAGE_KEY = "blueprints_editor_v3_paging"

        // Sample data (note: your original paste had invalid JSON at the end; fixed here)
        const SAMPLE = {
          blueprints: [
            {
              name: "Angled Grip II",
              workshop: "Gunsmith II",
              image: "",
              crafting_recipe: [
                { item: "Mechanical Components", quantity: 2 },
                { item: "Duct Tape", quantity: 3 },
              ],
              available: true,
              loot: true,
              harvester_event: false,
              quest_reward: false,
              trials_reward: false,
            },
            {
              name: "Angled Grip III",
              workshop: "Gunsmith III",
              image: "",
              crafting_recipe: [
                { item: "Mod Components", quantity: 2 },
                { item: "Duct Tape", quantity: 5 },
              ],
              available: true,
              loot: true,
              harvester_event: false,
              quest_reward: false,
              trials_reward: false,
            },
            {
              name: "Anvil",
              workshop: "Gunsmith II",
              image: "",
              crafting_recipe: [
                { item: "Mechanical Components", quantity: 5 },
                { item: "Simple Gun Parts", quantity: 5 },
              ],
              available: true,
              loot: true,
              harvester_event: false,
              quest_reward: false,
              trials_reward: true,
            },
            {
              name: "Anvil Splitter",
              workshop: "N/A",
              image: "",
              crafting_recipe: [{ item: "N/A", quantity: 0 }],
              available: true,
              loot: false,
              harvester_event: false,
              quest_reward: false,
              trials_reward: false,
            },
            {
              name: "Aphelion",
              workshop: "Gunsmith III",
              image: "",
              crafting_recipe: [
                { item: "Magnetic Accelerator", quantity: 3 },
                { item: "Complex Gun Parts", quantity: 5 },
                { item: "Matriarch Reactor", quantity: 1 },
              ],
              available: true,
              loot: true,
              harvester_event: false,
              quest_reward: false,
              trials_reward: false,
            },
            {
              name: "Barricade Kit",
              workshop: "Utility Station II",
              image: "",
              crafting_recipe: [{ item: "Mechanical Components", quantity: 1 }],
              available: true,
              loot: true,
              harvester_event: false,
              quest_reward: false,
              trials_reward: false,
            },
            {
              name: "Bettina",
              workshop: "Gunsmith III",
              image: "",
              crafting_recipe: [
                { item: "Advanced Mechanical Components", quantity: 3 },
                { item: "Heavy Gun Parts", quantity: 3 },
                { item: "Canister", quantity: 3 },
              ],
              available: true,
              loot: true,
              harvester_event: false,
              quest_reward: false,
              trials_reward: false,
            },
            {
              name: "Blaze Grenade",
              workshop: "Explosives Station III",
              image: "",
              crafting_recipe: [
                { item: "Explosive Compound", quantity: 1 },
                { item: "Oil", quantity: 2 },
              ],
              available: true,
              loot: true,
              harvester_event: false,
              quest_reward: false,
              trials_reward: true,
            },
            {
              name: "Blue Light Stick",
              workshop: "Utility Station I",
              image: "",
              crafting_recipe: [{ item: "Chemicals", quantity: 3 }],
              available: true,
              loot: true,
              harvester_event: false,
              quest_reward: false,
              trials_reward: true,
            },
            {
              name: "Bobcat",
              workshop: "Gunsmith III",
              image: "",
              crafting_recipe: [
                { item: "Magnetic Accelerator", quantity: 1 },
                { item: "Light Gun Parts", quantity: 3 },
                { item: "Exodus Modules", quantity: 2 },
              ],
              available: true,
              loot: true,
              harvester_event: false,
              quest_reward: false,
              trials_reward: false,
            },
          ],
        }

        // --- state ---
        let data = loadFromStorage() ?? structuredClone(SAMPLE)
        let selectedIndex = -1

        // paging state (defaults requested)
        let pageSize = 10
        let page = 1

        // --- elements ---
        const elList = document.getElementById("list")
        const elEditor = document.getElementById("editor")
        const elStatus = document.getElementById("status")

        const elSearch = document.getElementById("search")
        const elFilterAvailability =
          document.getElementById("filterAvailability")

        const elCountShown = document.getElementById("countShown")
        const elPageNow = document.getElementById("pageNow")
        const elPageTotal = document.getElementById("pageTotal")
        const elPageSize = document.getElementById("pageSize")
        const btnPrevPage = document.getElementById("btnPrevPage")
        const btnNextPage = document.getElementById("btnNextPage")

        const btnNew = document.getElementById("btnNew")
        const btnDelete = document.getElementById("btnDelete")
        const btnDuplicate = document.getElementById("btnDuplicate")
        const btnReset = document.getElementById("btnReset")
        const fileInput = document.getElementById("fileInput")

        // paste modal
        const modalPaste = document.getElementById("modalPaste")
        const btnPaste = document.getElementById("btnPaste")
        const btnClosePaste = document.getElementById("btnClosePaste")
        const btnLoadPasted = document.getElementById("btnLoadPasted")
        const pasteArea = document.getElementById("pasteArea")
        const pasteError = document.getElementById("pasteError")

        // json modal
        const modalJson = document.getElementById("modalJson")
        const btnViewJson = document.getElementById("btnViewJson")
        const btnCloseJson = document.getElementById("btnCloseJson")
        const btnCopyJson = document.getElementById("btnCopyJson")
        const btnDownloadJson = document.getElementById("btnDownloadJson")
        const elJsonPreview = document.getElementById("jsonPreview")

        // --- helpers ---
        function setStatus(type, msg) {
          const base = "mt-3 px-3 py-2 rounded-xl border text-sm"
          const styles = {
            ok: "bg-emerald-950/40 border-emerald-900 text-emerald-200",
            warn: "bg-amber-950/40 border-amber-900 text-amber-200",
            err: "bg-red-950/40 border-red-900 text-red-200",
            info: "bg-zinc-900/60 border-zinc-800 text-zinc-200",
          }
          elStatus.className = base + " " + (styles[type] || styles.info)
          elStatus.textContent = msg
        }

        function clampInt(n, fallback = 0) {
          const x = Number(n)
          if (!Number.isFinite(x)) return fallback
          return Math.max(0, Math.trunc(x))
        }

        function ensureShape(obj) {
          if (!obj || typeof obj !== "object")
            throw new Error("Root must be an object")
          if (!Array.isArray(obj.blueprints)) obj.blueprints = []
          obj.blueprints = obj.blueprints.map((bp) => {
            const b = bp && typeof bp === "object" ? bp : {}
            b.name = String(b.name ?? "")
            b.workshop = String(b.workshop ?? "")
            b.image = String(b.image ?? "")
            if (!Array.isArray(b.crafting_recipe)) b.crafting_recipe = []
            b.crafting_recipe = b.crafting_recipe.map((r) => {
              const rr = r && typeof r === "object" ? r : {}
              return {
                item: String(rr.item ?? ""),
                quantity: clampInt(rr.quantity ?? 0, 0),
              }
            })
            b.available = !!b.available
            b.loot = !!b.loot
            b.harvester_event = !!b.harvester_event
            b.quest_reward = !!b.quest_reward
            b.trials_reward = !!b.trials_reward
            return b
          })
          return obj
        }

        function saveToStorage() {
          try {
            localStorage.setItem(STORAGE_KEY, JSON.stringify(data))
          } catch {
            setStatus(
              "warn",
              "Could not autosave to localStorage (maybe blocked)."
            )
          }
        }

        function loadFromStorage() {
          try {
            const raw = localStorage.getItem(STORAGE_KEY)
            if (!raw) return null
            return ensureShape(JSON.parse(raw))
          } catch {
            return null
          }
        }

        function download(filename, text) {
          const blob = new Blob([text], { type: "application/json" })
          const url = URL.createObjectURL(blob)
          const a = document.createElement("a")
          a.href = url
          a.download = filename
          document.body.appendChild(a)
          a.click()
          a.remove()
          URL.revokeObjectURL(url)
        }

        function escapeHtml(s) {
          return String(s)
            .replaceAll("&", "&amp;")
            .replaceAll("<", "&lt;")
            .replaceAll(">", "&gt;")
            .replaceAll('"', "&quot;")
            .replaceAll("'", "&#39;")
        }

        // --- filtering + paging ---
        function getFilteredIndices() {
          const q = (elSearch.value || "").trim().toLowerCase()
          const availFilter = elFilterAvailability.value

          return data.blueprints
            .map((bp, idx) => ({ bp, idx }))
            .filter(({ bp }) => {
              const hay = (bp.name + " " + bp.workshop).toLowerCase()
              const matchQ = !q || hay.includes(q)
              const matchAvail =
                availFilter === "all" ||
                (availFilter === "available" && bp.available) ||
                (availFilter === "unavailable" && !bp.available)
              return matchQ && matchAvail
            })
            .map((x) => x.idx)
        }

        function pageCount(totalItems) {
          return Math.max(1, Math.ceil(totalItems / pageSize))
        }

        function clampPage(p, totalPages) {
          return Math.min(Math.max(1, p), totalPages)
        }

        function ensureSelectedVisible(filteredIndices) {
          if (selectedIndex < 0) return
          const pos = filteredIndices.indexOf(selectedIndex)
          if (pos === -1) return // selected not in filtered results
          const desiredPage = Math.floor(pos / pageSize) + 1
          if (desiredPage !== page) page = desiredPage
        }

        function setPagingUi(totalItems) {
          const totalPages = pageCount(totalItems)
          page = clampPage(page, totalPages)

          elPageNow.textContent = String(page)
          elPageTotal.textContent = String(totalPages)
          btnPrevPage.disabled = page <= 1
          btnNextPage.disabled = page >= totalPages
        }

        // --- list render (paged) ---
        function renderList() {
          elList.innerHTML = ""

          const filtered = getFilteredIndices()
          ensureSelectedVisible(filtered)

          const totalItems = filtered.length
          elCountShown.textContent = String(totalItems)

          const totalPages = pageCount(totalItems)
          page = clampPage(page, totalPages)
          setPagingUi(totalItems)

          if (totalItems === 0) {
            const empty = document.createElement("div")
            empty.className = "p-6 text-sm text-zinc-400"
            empty.textContent = "No matches. Try a different search/filter."
            elList.appendChild(empty)
            return
          }

          const start = (page - 1) * pageSize
          const end = start + pageSize
          const pageIndices = filtered.slice(start, end)

          pageIndices.forEach((idx) => {
            const bp = data.blueprints[idx]
            const flags = [
              bp.available ? "Available" : "Unavailable",
              bp.loot ? "Loot" : null,
              bp.harvester_event ? "Harvester" : null,
              bp.quest_reward ? "Quest" : null,
              bp.trials_reward ? "Trials" : null,
            ].filter(Boolean)

            const wrapper = document.createElement("button")
            wrapper.className =
              "w-full text-left p-3 border-b border-zinc-800 hover:bg-zinc-800/40 focus:outline-none " +
              (idx === selectedIndex ? "bg-indigo-950/40" : "bg-transparent")

            wrapper.innerHTML = `
        <div class="flex items-start gap-3">
          ${bp.image
            ? `<img src="${escapeHtml(bp.image)}" alt="${escapeHtml(bp.name || "Blueprint")}" class="mt-0.5 w-9 h-9 rounded-xl border border-zinc-800 bg-zinc-950 object-cover" data-thumb-img>`
              + `<div class="mt-0.5 w-9 h-9 rounded-xl border border-zinc-800 bg-zinc-950 grid place-items-center text-sm hidden" data-thumb-fallback>${String(idx + 1).padStart(2, "0")}</div>`
            : `<div class="mt-0.5 w-9 h-9 rounded-xl border border-zinc-800 bg-zinc-950 grid place-items-center text-sm">${String(idx + 1).padStart(2, "0")}</div>`
          }
          <div class="min-w-0 flex-1">
            <div class="flex items-center gap-2">
              <div class="font-semibold truncate">${escapeHtml(
                bp.name || "(unnamed)"
              )}</div>
              ${
                bp.available
                  ? `<span class="text-[11px] px-2 py-0.5 rounded-full bg-emerald-900/40 border border-emerald-900 text-emerald-200">A</span>`
                  : `<span class="text-[11px] px-2 py-0.5 rounded-full bg-zinc-800 border border-zinc-700 text-zinc-300">NA</span>`
              }
            </div>
            <div class="text-xs text-zinc-400 truncate">${escapeHtml(
              bp.workshop || ""
            )}</div>
            <div class="mt-2 flex flex-wrap gap-1">
              ${flags
                .map(
                  (f) =>
                    `<span class="text-[11px] px-2 py-0.5 rounded-full bg-zinc-950 border border-zinc-800 text-zinc-300">${escapeHtml(
                      f
                    )}</span>`
                )
                .join("")}
              <span class="text-[11px] px-2 py-0.5 rounded-full bg-zinc-950 border border-zinc-800 text-zinc-400">
                Recipe: ${bp.crafting_recipe.length}
              </span>
            </div>
          </div>
        </div>
      `

            const thumbImg = wrapper.querySelector("[data-thumb-img]")
            if (thumbImg) {
              thumbImg.addEventListener("error", () => {
                thumbImg.classList.add("hidden")
                wrapper.querySelector("[data-thumb-fallback]").classList.remove("hidden")
              })
            }

            wrapper.addEventListener("click", () => {
              selectedIndex = idx
              renderList() // highlight selection (and keep page)
              renderEditor() // show editor
            })

            elList.appendChild(wrapper)
          })
        }

        // --- editor render (focus-safe: never re-render on keystrokes) ---
        function checkboxPill(label, checked, onChange) {
          const wrap = document.createElement("label")
          wrap.className =
            "inline-flex items-center gap-2 px-3 py-2 rounded-xl border cursor-pointer select-none " +
            (checked
              ? "bg-indigo-950/40 border-indigo-800 text-indigo-100"
              : "bg-zinc-950 border-zinc-800 text-zinc-200")
          wrap.innerHTML = `
      <input type="checkbox" class="hidden" ${checked ? "checked" : ""} />
      <span class="w-4 h-4 rounded-md border ${
        checked
          ? "border-indigo-400 bg-indigo-600"
          : "border-zinc-600 bg-transparent"
      }"></span>
      <span class="text-sm font-medium">${escapeHtml(label)}</span>
    `
          const input = wrap.querySelector("input")
          input.addEventListener("change", () => onChange(input.checked))
          return wrap
        }

        function renderEditor() {
          btnDelete.disabled = selectedIndex < 0
          btnDuplicate.disabled = selectedIndex < 0

          if (selectedIndex < 0) {
            elEditor.innerHTML = `<div class="text-zinc-400 text-sm">No blueprint selected.</div>`
            return
          }

          const bp = data.blueprints[selectedIndex]
          const container = document.createElement("div")
          container.className = "space-y-4"

          function row(label, help) {
            const r = document.createElement("div")
            r.className = "grid grid-cols-1 md:grid-cols-12 gap-2 items-start"
            r.innerHTML = `
        <div class="md:col-span-4">
          <div class="text-sm font-medium">${escapeHtml(label)}</div>
          ${
            help
              ? `<div class="text-xs text-zinc-400 mt-0.5">${escapeHtml(
                  help
                )}</div>`
              : ""
          }
        </div>
        <div class="md:col-span-8"></div>
      `
            return r
          }

          // Name
          const rName = row("Name", "Blueprint display name")
          const nameInput = document.createElement("input")
          nameInput.className =
            "w-full px-3 py-2 rounded-xl bg-zinc-950 border border-zinc-800 focus:outline-none focus:ring-2 focus:ring-indigo-500 text-sm"
          nameInput.value = bp.name
          nameInput.addEventListener("input", () => {
            bp.name = nameInput.value
            saveToStorage()
            renderList() // only list refresh
            updateJsonTextIfOpen()
          })
          rName.querySelector(".md\\:col-span-8").appendChild(nameInput)
          container.appendChild(rName)

          // Workshop
          const rWs = row(
            "Workshop",
            "e.g. Gunsmith II, Utility Station I, N/A"
          )
          const wsInput = document.createElement("input")
          wsInput.className =
            "w-full px-3 py-2 rounded-xl bg-zinc-950 border border-zinc-800 focus:outline-none focus:ring-2 focus:ring-indigo-500 text-sm"
          wsInput.value = bp.workshop
          wsInput.addEventListener("input", () => {
            bp.workshop = wsInput.value
            saveToStorage()
            renderList()
            updateJsonTextIfOpen()
          })
          rWs.querySelector(".md\\:col-span-8").appendChild(wsInput)
          container.appendChild(rWs)

          // Image
          const rImg = row("Image", "Path or upload an image file")
          const imgWrap = document.createElement("div")
          imgWrap.className = "space-y-2"

          // Hidden file input for image upload
          const imgFileInput = document.createElement("input")
          imgFileInput.type = "file"
          imgFileInput.accept = "image/*"
          imgFileInput.style.display = "none"

          // Text input row with browse button
          const imgInputRow = document.createElement("div")
          imgInputRow.className = "flex gap-2"

          const imgInput = document.createElement("input")
          imgInput.className =
            "flex-1 px-3 py-2 rounded-xl bg-zinc-950 border border-zinc-800 focus:outline-none focus:ring-2 focus:ring-indigo-500 text-sm"
          imgInput.value = bp.image && !bp.image.startsWith("data:") ? bp.image : ""
          imgInput.placeholder = "images/example.png"
          imgInput.addEventListener("input", () => {
            bp.image = imgInput.value
            saveToStorage()
            renderList()
            updateJsonTextIfOpen()
            updateImgPreview()
          })
          imgInputRow.appendChild(imgInput)

          const imgBrowseBtn = document.createElement("button")
          imgBrowseBtn.type = "button"
          imgBrowseBtn.className =
            "px-3 py-2 rounded-xl bg-indigo-600/90 hover:bg-indigo-600 text-sm font-medium whitespace-nowrap"
          imgBrowseBtn.textContent = "Browse‚Ä¶"
          imgBrowseBtn.addEventListener("click", () => imgFileInput.click())
          imgInputRow.appendChild(imgBrowseBtn)

          imgWrap.appendChild(imgFileInput)
          imgWrap.appendChild(imgInputRow)

          // Image preview
          const imgPreview = document.createElement("img")
          imgPreview.className =
            "w-32 h-32 object-contain rounded-xl border border-zinc-800 bg-zinc-950" +
            (bp.image ? "" : " hidden")
          if (bp.image) imgPreview.src = bp.image
          imgPreview.alt = "Blueprint image preview"
          imgPreview.addEventListener("error", () => {
            imgPreview.classList.add("hidden")
            imgEmpty.classList.remove("hidden")
          })

          // Drop zone / empty placeholder (clickable)
          const imgEmpty = document.createElement("div")
          imgEmpty.className =
            "w-32 h-32 rounded-xl border-2 border-dashed border-zinc-700 bg-zinc-950 grid place-items-center text-zinc-500 text-xs cursor-pointer transition-colors" +
            (bp.image ? " hidden" : "")
          imgEmpty.innerHTML = `<div class="text-center pointer-events-none"><div class="text-lg mb-1">‚¨ÜÔ∏è</div><div>Drop image<br>or click</div></div>`
          imgEmpty.setAttribute("role", "button")
          imgEmpty.setAttribute("aria-label", "Click or drag to upload image")
          imgEmpty.addEventListener("click", () => imgFileInput.click())

          // Make preview clickable too
          imgPreview.style.cursor = "pointer"
          imgPreview.addEventListener("click", () => imgFileInput.click())

          // Drag-and-drop on the drop zone and preview
          function handleImageFile(file) {
            if (!file) return
            if (!file.type.startsWith("image/")) {
              setStatus("warn", "Only image files are accepted.")
              return
            }
            const reader = new FileReader()
            reader.onload = () => {
              bp.image = reader.result
              imgInput.value = ""
              saveToStorage()
              renderList()
              updateJsonTextIfOpen()
              updateImgPreview()
            }
            reader.readAsDataURL(file)
          }

          function updateImgPreview() {
            if (bp.image) {
              imgPreview.src = bp.image
              imgPreview.classList.remove("hidden")
              imgEmpty.classList.add("hidden")
            } else {
              imgPreview.classList.add("hidden")
              imgEmpty.classList.remove("hidden")
            }
          }

          ;[imgEmpty, imgPreview].forEach((el) => {
            el.addEventListener("dragover", (e) => {
              e.preventDefault()
              e.stopPropagation()
              el.classList.add("ring-2", "ring-indigo-500")
            })
            el.addEventListener("dragleave", (e) => {
              e.preventDefault()
              e.stopPropagation()
              el.classList.remove("ring-2", "ring-indigo-500")
            })
            el.addEventListener("drop", (e) => {
              e.preventDefault()
              e.stopPropagation()
              el.classList.remove("ring-2", "ring-indigo-500")
              const file = e.dataTransfer?.files?.[0]
              handleImageFile(file)
            })
          })

          // File input change handler
          imgFileInput.addEventListener("change", () => {
            const file = imgFileInput.files?.[0]
            imgFileInput.value = ""
            handleImageFile(file)
          })

          imgWrap.appendChild(imgPreview)
          imgWrap.appendChild(imgEmpty)

          rImg.querySelector(".md\\:col-span-8").appendChild(imgWrap)
          container.appendChild(rImg)

          // Flags
          const rFlags = row("Flags", "Toggle each boolean field")
          const pillsWrap = document.createElement("div")
          pillsWrap.className = "flex flex-wrap gap-2"
          ;[
            ["Available", "available"],
            ["Loot", "loot"],
            ["Harvester event", "harvester_event"],
            ["Quest reward", "quest_reward"],
            ["Trials reward", "trials_reward"],
          ].forEach(([label, key]) => {
            pillsWrap.appendChild(
              checkboxPill(label, !!bp[key], (v) => {
                bp[key] = v
                saveToStorage()
                renderList()
                renderEditor() // for pill styling consistency
                updateJsonTextIfOpen()
              })
            )
          })
          rFlags.querySelector(".md\\:col-span-8").appendChild(pillsWrap)
          container.appendChild(rFlags)

          // Recipe
          const recipeCard = document.createElement("div")
          recipeCard.className =
            "rounded-2xl border border-zinc-800 bg-zinc-950/40 overflow-hidden"

          const recipeHeader = document.createElement("div")
          recipeHeader.className =
            "p-3 border-b border-zinc-800 flex items-center justify-between"
          recipeHeader.innerHTML = `
      <div>
        <div class="font-semibold">Crafting recipe</div>
        <div class="text-xs text-zinc-400">Edit items and quantities</div>
      </div>
    `
          const btnAddRow = document.createElement("button")
          btnAddRow.className =
            "px-3 py-2 rounded-xl bg-emerald-600/90 hover:bg-emerald-600 text-sm font-medium"
          btnAddRow.textContent = "+ Add ingredient"
          btnAddRow.addEventListener("click", () => {
            bp.crafting_recipe.push({ item: "", quantity: 0 })
            saveToStorage()
            renderEditor()
            renderList() // updates recipe count badge
            updateJsonTextIfOpen()
          })
          recipeHeader.appendChild(btnAddRow)
          recipeCard.appendChild(recipeHeader)

          const body = document.createElement("div")
          body.className = "p-3 space-y-2"

          if (bp.crafting_recipe.length === 0) {
            const empty = document.createElement("div")
            empty.className = "text-sm text-zinc-400"
            empty.textContent = "No ingredients. Add one."
            body.appendChild(empty)
          } else {
            bp.crafting_recipe.forEach((row, i) => {
              const r = document.createElement("div")
              r.className = "grid grid-cols-12 gap-2 items-center"

              const item = document.createElement("input")
              item.className =
                "col-span-7 px-3 py-2 rounded-xl bg-zinc-950 border border-zinc-800 focus:outline-none focus:ring-2 focus:ring-indigo-500 text-sm"
              item.value = row.item
              item.placeholder = "Item name"
              item.addEventListener("input", () => {
                row.item = item.value
                saveToStorage()
                updateJsonTextIfOpen()
              })

              const qty = document.createElement("input")
              qty.type = "number"
              qty.min = "0"
              qty.step = "1"
              qty.className =
                "col-span-3 px-3 py-2 rounded-xl bg-zinc-950 border border-zinc-800 focus:outline-none focus:ring-2 focus:ring-indigo-500 text-sm"
              qty.value = String(row.quantity ?? 0)
              qty.addEventListener("input", () => {
                row.quantity = clampInt(qty.value, 0)
                saveToStorage()
                updateJsonTextIfOpen()
              })

              const del = document.createElement("button")
              del.className =
                "col-span-2 px-3 py-2 rounded-xl bg-zinc-900 hover:bg-red-600/20 border border-zinc-800 hover:border-red-800 text-sm font-medium"
              del.textContent = "Remove"
              del.addEventListener("click", () => {
                bp.crafting_recipe.splice(i, 1)
                saveToStorage()
                renderEditor()
                renderList()
                updateJsonTextIfOpen()
              })

              r.appendChild(item)
              r.appendChild(qty)
              r.appendChild(del)
              body.appendChild(r)
            })
          }

          recipeCard.appendChild(body)
          container.appendChild(recipeCard)

          elEditor.innerHTML = ""
          elEditor.appendChild(container)
        }

        // --- JSON modal ---
        function jsonText() {
          return JSON.stringify(data, null, 2)
        }
        function updateJsonTextIfOpen() {
          if (!modalJson.classList.contains("hidden"))
            elJsonPreview.textContent = jsonText()
        }
        function openJson() {
          elJsonPreview.textContent = jsonText()
          modalJson.classList.remove("hidden")
          modalJson.classList.add("flex")
        }
        function closeJson() {
          modalJson.classList.add("hidden")
          modalJson.classList.remove("flex")
        }

        // --- Paste modal ---
        function openPaste() {
          pasteArea.value = ""
          pasteError.textContent = ""
          modalPaste.classList.remove("hidden")
          modalPaste.classList.add("flex")
          pasteArea.focus()
        }
        function closePaste() {
          modalPaste.classList.add("hidden")
          modalPaste.classList.remove("flex")
        }

        // --- top-level render ---
        function renderAll() {
          renderList()
          renderEditor()
        }

        // --- events ---
        elSearch.addEventListener("input", () => {
          page = 1
          renderList()
        })
        elFilterAvailability.addEventListener("change", () => {
          page = 1
          renderList()
        })

        elPageSize.addEventListener("change", () => {
          pageSize = clampInt(elPageSize.value, 10) || 10
          page = 1
          renderList()
        })

        btnPrevPage.addEventListener("click", () => {
          page = Math.max(1, page - 1)
          renderList()
        })

        btnNextPage.addEventListener("click", () => {
          page = page + 1
          renderList()
        })

        btnNew.addEventListener("click", () => {
          data.blueprints.push({
            name: "New Blueprint",
            workshop: "",
            image: "",
            crafting_recipe: [{ item: "", quantity: 0 }],
            available: true,
            loot: false,
            harvester_event: false,
            quest_reward: false,
            trials_reward: false,
          })
          selectedIndex = data.blueprints.length - 1
          saveToStorage()
          setStatus("ok", "Added a new blueprint.")
          renderAll()
        })

        btnDelete.addEventListener("click", () => {
          if (selectedIndex < 0) return
          const name = data.blueprints[selectedIndex]?.name || "this blueprint"
          if (!confirm(`Delete "${name}"?`)) return

          data.blueprints.splice(selectedIndex, 1)
          selectedIndex = Math.min(selectedIndex, data.blueprints.length - 1)
          saveToStorage()
          setStatus("ok", "Deleted.")
          renderAll()
          updateJsonTextIfOpen()
        })

        btnDuplicate.addEventListener("click", () => {
          if (selectedIndex < 0) return
          const original = data.blueprints[selectedIndex]
          const copy = structuredClone(original)
          copy.name = copy.name ? copy.name + " (Copy)" : "Copy"
          data.blueprints.splice(selectedIndex + 1, 0, copy)
          selectedIndex = selectedIndex + 1
          saveToStorage()
          setStatus("ok", "Duplicated.")
          renderAll()
          updateJsonTextIfOpen()
        })

        btnReset.addEventListener("click", () => {
          if (
            !confirm(
              "Reset editor to the sample data? This overwrites your current work (localStorage too)."
            )
          )
            return
          data = structuredClone(SAMPLE)
          selectedIndex = -1
          page = 1
          pageSize = 10
          elPageSize.value = "10"
          saveToStorage()
          setStatus("ok", "Reset to sample.")
          renderAll()
          updateJsonTextIfOpen()
        })

        fileInput.addEventListener("change", async () => {
          const file = fileInput.files?.[0]
          fileInput.value = ""
          if (!file) return

          try {
            const text = await file.text()
            const parsed = ensureShape(JSON.parse(text))
            data = parsed
            selectedIndex = -1
            page = 1
            saveToStorage()
            setStatus("ok", `Loaded ${file.name}`)
            renderAll()
            updateJsonTextIfOpen()
          } catch (e) {
            setStatus("err", `Could not load JSON: ${e.message || e}`)
          }
        })

        // paste modal bindings
        btnPaste.addEventListener("click", openPaste)
        btnClosePaste.addEventListener("click", closePaste)
        modalPaste.addEventListener("click", (e) => {
          if (e.target === modalPaste) closePaste()
        })

        btnLoadPasted.addEventListener("click", () => {
          pasteError.textContent = ""
          try {
            const parsed = ensureShape(JSON.parse(pasteArea.value))
            data = parsed
            selectedIndex = -1
            page = 1
            saveToStorage()
            setStatus("ok", "Loaded pasted JSON.")
            closePaste()
            renderAll()
            updateJsonTextIfOpen()
          } catch (e) {
            pasteError.textContent = `Parse error: ${e.message || e}`
          }
        })

        // json modal bindings
        btnViewJson.addEventListener("click", openJson)
        btnCloseJson.addEventListener("click", closeJson)
        modalJson.addEventListener("click", (e) => {
          if (e.target === modalJson) closeJson()
        })

        btnCopyJson.addEventListener("click", async () => {
          try {
            await navigator.clipboard.writeText(jsonText())
            setStatus("ok", "Copied JSON to clipboard.")
          } catch {
            setStatus("warn", "Clipboard copy failed (browser permissions).")
          }
        })

        btnDownloadJson.addEventListener("click", () => {
          const stamp = new Date().toISOString().slice(0, 10)
          download(`blueprints_${stamp}.json`, jsonText())
          setStatus("ok", "Downloaded JSON.")
        })

        // init
        try {
          data = ensureShape(data)
          setStatus(
            "info",
            loadFromStorage()
              ? "Loaded from localStorage."
              : "Loaded sample data."
          )
        } catch {
          data = structuredClone(SAMPLE)
          setStatus("warn", "Stored data was invalid; reset to sample.")
        }

        // initial paging defaults
        pageSize = clampInt(elPageSize.value, 10) || 10
        page = 1

        renderAll()
      })()
    </script>
  </body>
</html>
